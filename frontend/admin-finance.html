<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>財務審核 - 小跑豬後台</title>
    <link rel="icon" href="assets/logo.png" type="image/png" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="css/admin-modern.css" />
    <link rel="stylesheet" href="css/modals-unified.css" />
    <style>
      /* --- [核心修復] Modal 定位與遮罩樣式 --- */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 2000; /* 確保在佈局之上 */
        align-items: center;
        justify-content: center;
      }
      .modal-card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        max-height: 90vh;
        overflow-y: auto;
      }
      #user-search-results div:hover {
        background: #f0f7ff;
      }
      /* [新增] 視圖切換按鈕樣式 */
      .view-tabs {
        display: flex;
        gap: 5px;
        margin-bottom: 15px;
      }
      .view-tabs .btn {
        border-radius: 20px;
        padding: 6px 20px;
        font-weight: 500;
      }
      .view-tabs .btn.active {
        background-color: var(--primary-color, #4a90e2);
        color: #fff;
        border-color: var(--primary-color, #4a90e2);
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <h1 class="page-title">財務管理與審核</h1>

      <div class="view-tabs">
        <button
          class="btn btn-outline-primary active"
          id="btn-view-transactions"
        >
          <i class="fas fa-list-ul"></i> 交易紀錄
        </button>
        <button class="btn btn-outline-primary" id="btn-view-wallets">
          <i class="fas fa-wallet"></i> 會員錢包總覽
        </button>
      </div>

      <div class="card mb-3">
        <div class="card-body">
          <div
            class="filters-bar"
            style="
              display: flex;
              gap: 10px;
              flex-wrap: wrap;
              align-items: center;
            "
          >
            <div style="flex: 1; min-width: 200px">
              <input
                type="text"
                id="search-input"
                class="form-control"
                placeholder="搜尋會員姓名、Email 或 Piggy ID..."
              />
            </div>
            <div style="flex: 0 0 150px">
              <select id="status-filter" class="form-control">
                <option value="PENDING">待審核 (PENDING)</option>
                <option value="COMPLETED">已完成 (COMPLETED)</option>
                <option value="REJECTED">已駁回 (REJECTED)</option>
                <option value="">所有狀態</option>
              </select>
            </div>
            <div style="flex: 0 0 150px">
              <select id="type-filter" class="form-control">
                <option value="">所有類型</option>
                <option value="DEPOSIT">儲值 (Deposit)</option>
                <option value="PAYMENT">扣款 (Payment)</option>
                <option value="ADJUST">人工調整 (Adjust)</option>
              </select>
            </div>
            <button class="btn btn-primary" id="btn-search">
              <i class="fas fa-search"></i> 查詢
            </button>
            <button class="btn btn-warning" id="btn-manual-adjust">
              <i class="fas fa-coins"></i> 手動調整餘額
            </button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <span><i class="fas fa-file-invoice-dollar"></i> 數據清單</span>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="modern-table">
              <thead>
                <tr>
                  <th>時間</th>
                  <th>會員資訊</th>
                  <th>類型</th>
                  <th>金額</th>
                  <th>發票狀態</th>
                  <th>說明 / 憑證</th>
                  <th>狀態</th>
                  <th class="text-right">操作</th>
                </tr>
              </thead>
              <tbody id="transaction-list">
                <tr>
                  <td colspan="9" class="text-center p-3">載入中...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="card-footer" id="pagination"></div>
      </div>

      <div id="proof-modal" class="modal">
        <div class="modal-card card" style="max-width: 500px; width: 90%">
          <div
            class="card-header d-flex justify-content-between align-items-center"
          >
            <span>匯款憑證詳情</span>
            <button type="button" class="modal-close-btn btn btn-sm btn-danger">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="card-body text-center">
            <img
              id="proof-img-display"
              src=""
              style="
                max-width: 100%;
                max-height: 60vh;
                border: 1px solid #ddd;
                border-radius: 8px;
                margin-bottom: 15px;
                display: none;
              "
            />
            <div
              id="review-actions"
              style="display: none; gap: 10px; justify-content: center"
            >
              <button class="btn btn-success" id="btn-approve">
                通過審核 (加值)
              </button>
              <button class="btn btn-danger" id="btn-reject">駁回申請</button>
            </div>
          </div>
        </div>
      </div>

      <div id="adjust-modal" class="modal">
        <div class="modal-card card" style="width: 500px; max-width: 90%">
          <div class="card-header d-flex justify-content-between">
            <span>人工調整餘額</span>
            <button type="button" class="modal-close-btn btn btn-sm btn-danger">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="card-body">
            <form id="adjust-form">
              <div class="form-group mb-3">
                <label>目標會員 (已鎖定或搜尋)</label>
                <div style="position: relative">
                  <input
                    type="text"
                    id="adjust-search-user"
                    class="form-control"
                    autocomplete="off"
                    required
                    placeholder="輸入關鍵字..."
                  />
                  <div
                    id="user-search-results"
                    style="
                      display: none;
                      position: absolute;
                      top: 100%;
                      left: 0;
                      width: 100%;
                      background: white;
                      border: 1px solid #ddd;
                      z-index: 10;
                      max-height: 150px;
                      overflow-y: auto;
                      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                    "
                  ></div>
                </div>
                <input type="hidden" id="adjust-user-id" />
              </div>
              <div class="form-group mb-3">
                <label>調整金額 (NT$)</label>
                <input
                  type="number"
                  id="adjust-amount"
                  class="form-control"
                  required
                  placeholder="正數加錢，負數扣錢"
                />
                <small class="text-danger"
                  >例：輸入 1000 增加餘額；輸入 -500 扣除錢包。</small
                >
              </div>
              <div class="form-group mb-3">
                <label>調整原因 / 備註</label>
                <input
                  type="text"
                  id="adjust-note"
                  class="form-control"
                  required
                  placeholder="例如：人工補償、運費退回"
                />
              </div>
              <button type="submit" class="btn btn-primary w-100">
                確認調整並更新餘額
              </button>
            </form>
          </div>
        </div>
      </div>

      <div id="edit-tx-modal" class="modal">
        <div class="modal-card card" style="width: 500px; max-width: 90%">
          <div class="card-header d-flex justify-content-between">
            <span>編輯交易紀錄</span>
            <button type="button" class="modal-close-btn btn btn-sm btn-danger">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="card-body">
            <form id="edit-tx-form">
              <div class="form-group mb-3">
                <label>交易金額 (已完成交易不可修改)</label>
                <input type="number" id="edit-tx-amount" class="form-control" />
              </div>
              <div class="form-group mb-3">
                <label>統一編號 (選填)</label>
                <input
                  type="text"
                  id="edit-tx-taxid"
                  class="form-control"
                  placeholder="8碼統編"
                />
              </div>
              <div class="form-group mb-3">
                <label>發票抬頭 (選填)</label>
                <input
                  type="text"
                  id="edit-tx-title"
                  class="form-control"
                  placeholder="公司名稱"
                />
              </div>
              <div class="form-group mb-3">
                <label>備註說明</label>
                <textarea
                  id="edit-tx-desc"
                  class="form-control"
                  rows="3"
                ></textarea>
              </div>
              <button type="submit" class="btn btn-primary w-100">
                儲存變更
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <script src="js/apiConfig.js"></script>
    <script src="js/admin-layout.js"></script>
    <script src="js/admin-finance.js"></script>
  </body>
</html>
