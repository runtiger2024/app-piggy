<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <title>會員中心 | 小跑豬傢俱專線</title>
    <link rel="icon" href="assets/logo.png" type="image/png" />

    <script src="js/styleLoader.js"></script>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      /* --- Dashboard 專業版佈局優化 --- */

      /* 1. 全域背景與佈局 */
      .dashboard-theme {
        background-color: #f4f7fa;
      }

      /* 2. 高級 Hero 迎賓卡片 */
      .hero-dashboard {
        background: linear-gradient(135deg, var(--p-primary) 0%, #003a8c 100%);
        border-radius: 24px;
        padding: 30px;
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 10px 30px rgba(26, 115, 232, 0.25);
        margin-bottom: 25px;
        position: relative;
        overflow: hidden;
      }

      .hero-dashboard::after {
        content: "\f48b"; /* FontAwesome Box icon */
        font-family: "Font Awesome 6 Free";
        font-weight: 900;
        position: absolute;
        right: -20px;
        bottom: -30px;
        font-size: 12rem;
        color: rgba(255, 255, 255, 0.05);
      }

      .user-welcome h2 {
        font-size: 1.8rem;
        font-weight: 800;
        margin-bottom: 8px;
      }

      .user-welcome p {
        opacity: 0.85;
        font-size: 0.95rem;
      }

      /* 3. 錢包整合樣式 */
      .wallet-summary-box {
        background: rgba(255, 255, 255, 0.12);
        backdrop-filter: blur(10px);
        padding: 20px 25px;
        border-radius: 18px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        text-align: right;
        min-width: 220px;
        cursor: pointer;
        transition: transform 0.3s ease;
      }

      .wallet-summary-box:hover {
        transform: translateY(-3px);
        background: rgba(255, 255, 255, 0.18);
      }

      .ws-label {
        font-size: 0.85rem;
        opacity: 0.9;
        margin-bottom: 5px;
      }

      .ws-amount {
        font-size: 2rem;
        font-weight: 900;
        font-family: "Monaco", monospace;
      }

      /* 4. 快速行動磁貼 (Quick Actions) */
      .quick-actions-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
        margin-bottom: 25px;
      }

      .action-tile {
        background: white;
        border: 1px solid #eef1f6;
        border-radius: 20px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        cursor: pointer;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
      }

      .action-tile:hover {
        transform: translateY(-8px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.08);
        border-color: var(--p-primary);
      }

      .tile-icon {
        width: 54px;
        height: 54px;
        background: var(--p-primary-bg);
        color: var(--p-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        border-radius: 15px;
      }

      .action-tile span {
        font-weight: 700;
        color: var(--text-main);
        font-size: 0.95rem;
      }

      /* 5. 即時動態進度條 (Status Bar) */
      .live-status-bar {
        background: white;
        border-radius: 20px;
        padding: 20px 0;
        display: flex;
        justify-content: space-around;
        align-items: center;
        margin-bottom: 25px;
        box-shadow: var(--shadow-1);
        border: 1px solid var(--border-light);
      }

      .status-node {
        text-align: center;
        flex: 1;
        position: relative;
      }

      .status-node:not(:last-child)::after {
        content: "\f054";
        font-family: "Font Awesome 6 Free";
        font-weight: 900;
        position: absolute;
        right: -5%;
        top: 30%;
        color: #ddd;
        font-size: 0.8rem;
      }

      .sn-count {
        display: block;
        font-size: 1.4rem;
        font-weight: 800;
        color: var(--p-primary);
        margin-bottom: 4px;
      }

      .sn-label {
        font-size: 0.8rem;
        color: var(--text-sub);
        font-weight: 600;
      }

      /* 6. 手機版 RWD 調優 */
      @media (max-width: 800px) {
        .hero-dashboard {
          flex-direction: column;
          text-align: center;
          padding: 25px;
        }
        .wallet-summary-box {
          margin-top: 20px;
          width: 100%;
          text-align: center;
        }
        .quick-actions-grid {
          grid-template-columns: repeat(2, 1fr);
        }
        .status-node:not(:last-child)::after {
          display: none;
        }
      }

      /* 保留原本預覽圖樣式 */
      .preview-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
      }
      .preview-container img {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 4px;
        border: 1px solid #ddd;
      }
    </style>
  </head>

  <body class="dashboard-theme">
    <div class="app-layout-wrapper">
      <header class="dashboard-header">
        <div
          class="header-container"
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
          "
        >
          <a href="index.html" class="logo-link">
            <img
              src="assets/logo.png"
              alt="小跑豬集運"
              class="header-logo-img"
            />
            <span class="logo-text">
              小跑豬
              <small>會 員 控 制 台</small>
            </span>
          </a>

          <div class="header-right-actions">
            <div class="notification-wrapper">
              <div id="btn-notification" class="notif-trigger">
                <i class="fas fa-bell"></i>
                <span
                  id="notification-badge"
                  class="notification-badge"
                  style="display: none"
                  >0</span
                >
              </div>
              <div id="notification-dropdown" class="notification-dropdown">
                <div class="dropdown-header">
                  <span>通知中心</span>
                  <button id="btn-read-all" class="btn-text">全部已讀</button>
                </div>
                <div id="notification-list" class="dropdown-body">
                  <div class="empty-state">載入中...</div>
                </div>
              </div>
            </div>
            <nav class="main-nav header-nav-right"></nav>
          </div>
        </div>
      </header>

      <div id="message-box" class="alert" style="display: none"></div>

      <div class="container main-content" style="padding-top: 20px">
        <section class="hero-dashboard animate-slide-up">
          <div class="user-welcome">
            <h2 id="welcome-message">您好，載入中...</h2>
            <p>
              <i class="fas fa-id-badge"></i>
              <span id="user-email">...</span>
            </p>
            <div style="margin-top: 15px; display: flex; gap: 12px">
              <button
                id="btn-edit-profile"
                class="btn btn-mini"
                style="
                  background: rgba(255, 255, 255, 0.15);
                  border: 1px solid rgba(255, 255, 255, 0.3);
                  color: #fff;
                  padding: 6px 15px;
                "
              >
                <i class="fas fa-user-edit"></i> 帳號設定
              </button>
            </div>
          </div>

          <div id="btn-quick-wallet" class="wallet-summary-box">
            <div class="ws-label">可用餘額 (TWD)</div>
            <div class="ws-amount" id="header-wallet-balance">0</div>
            <div
              class="ws-label"
              style="font-size: 0.7rem; margin-top: 6px; opacity: 0.8"
            >
              儲值或查看帳務 <i class="fas fa-chevron-right"></i>
            </div>
          </div>
        </section>

        <section
          class="live-status-bar animate-slide-up"
          style="animation-delay: 0.1s"
        >
          <div class="status-node">
            <span class="sn-count" id="count-pending">0</span>
            <span class="sn-label">待入庫</span>
          </div>
          <div class="status-node">
            <span class="sn-count" id="count-arrived">0</span>
            <span class="sn-label">已入庫</span>
          </div>
          <div class="status-node">
            <span class="sn-count" id="count-exception">0</span>
            <span class="sn-label">異常件</span>
          </div>
          <div class="status-node">
            <span class="sn-count" id="count-unpaid">0</span>
            <span class="sn-label">待付款</span>
          </div>
        </section>

        <section
          class="quick-actions-grid animate-slide-up"
          style="animation-delay: 0.15s"
        >
          <div
            class="action-tile"
            onclick="document.getElementById('tab-packages').click()"
          >
            <div class="tile-icon"><i class="fas fa-box-open"></i></div>
            <span>預報包裹</span>
          </div>
          <div
            class="action-tile"
            onclick="document.getElementById('tab-shipments').click()"
          >
            <div class="tile-icon"><i class="fas fa-shipping-fast"></i></div>
            <span>申請集運</span>
          </div>
          <div
            class="action-tile"
            onclick="location.href='furniture-procurement.html'"
          >
            <div class="tile-icon"><i class="fas fa-couch"></i></div>
            <span>傢俱代採</span>
          </div>
          <div class="action-tile" id="btn-claim-package-tile">
            <div class="tile-icon"><i class="fas fa-search-location"></i></div>
            <span>認領包裹</span>
          </div>
        </section>

        <div
          id="draft-queue-container"
          class="notice-card warning"
          style="display: none"
        >
          <div class="notice-content">
            <h4><i class="fas fa-clock"></i> 待處理的試算包裹</h4>
            <ul id="draft-queue-list"></ul>
          </div>
        </div>

        <div
          class="section-card"
          style="padding: 0; overflow: hidden; border-radius: 20px"
        >
          <div
            class="dashboard-tabs"
            style="margin: 0; background: #fff; border-bottom: 1px solid #eee"
          >
            <button id="tab-packages" class="tab-btn active">
              <i class="fas fa-boxes"></i> 包裹
            </button>
            <button id="tab-shipments" class="tab-btn">
              <i class="fas fa-file-invoice-dollar"></i> 單據
            </button>
            <button id="tab-wallet" class="tab-btn">
              <i class="fas fa-history"></i> 帳務
            </button>
            <button id="tab-recipients" class="tab-btn">
              <i class="fas fa-users"></i> 收件人
            </button>
            <button id="tab-unclaimed" class="tab-btn">
              <i class="fas fa-question-circle"></i> 無主
            </button>
          </div>

          <main class="dashboard-main-content" style="padding: 20px">
            <div id="packages-section" class="tab-content active">
              <div id="section-container-packages"></div>
            </div>
            <div
              id="shipments-section"
              class="tab-content"
              style="display: none"
            >
              <div id="section-container-shipments"></div>
            </div>
            <div
              id="recipient-section"
              class="tab-content"
              style="display: none"
            >
              <div id="section-container-recipients"></div>
            </div>
            <div id="wallet-section" class="tab-content" style="display: none">
              <div id="section-container-wallet"></div>
            </div>
            <div
              id="unclaimed-section"
              class="tab-content"
              style="display: none"
            >
              <div id="section-container-unclaimed-area">
                <div class="table-responsive">
                  <table class="app-table">
                    <thead>
                      <tr>
                        <th>入庫時間</th>
                        <th>單號(末5碼)</th>
                        <th>商品名稱</th>
                        <th>重量/資訊</th>
                        <th>操作</th>
                      </tr>
                    </thead>
                    <tbody id="unclaimed-table-body">
                      <tr>
                        <td colspan="5" class="text-center py-4">載入中...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </main>
        </div>

        <div class="safe-area-spacer"></div>
      </div>

      <div style="height: 100px"></div>
    </div>

    <nav id="mobile-bottom-nav" class="universal-bottom-nav"></nav>

    <div id="modal-container-profile-edit"></div>
    <div id="modal-container-password-change"></div>
    <div id="modal-container-shipment-create"></div>
    <div id="modal-container-deposit"></div>
    <div id="modal-container-bulk-forecast"></div>
    <div id="modal-container-claim-package"></div>

    <div id="edit-package-modal" class="modal-overlay" style="display: none">
      ...
    </div>
    <div
      id="recipient-selector-modal"
      class="modal-overlay"
      style="display: none"
    >
      ...
    </div>
    <div id="bank-info-modal" class="modal-overlay" style="display: none">
      ...
    </div>
    <div id="upload-proof-modal" class="modal-overlay" style="display: none">
      ...
    </div>
    <div id="package-details-modal" class="modal-overlay" style="display: none">
      ...
    </div>
    <div
      id="shipment-details-modal"
      class="modal-overlay"
      style="display: none"
    >
      ...
    </div>
    <div id="view-images-modal" class="modal-overlay" style="display: none">
      ...
    </div>

    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script>
      async function loadHtml(id, path) {
        try {
          const res = await fetch(path);
          if (res.ok) {
            const el = document.getElementById(id);
            if (el) el.innerHTML = await res.text();
          }
        } catch (e) {
          console.error(`Error loading ${path}`, e);
        }
      }

      Promise.all([
        loadHtml(
          "section-container-packages",
          "components/sections/packages.html"
        ),
        loadHtml(
          "section-container-shipments",
          "components/sections/shipments.html"
        ),
        loadHtml(
          "section-container-recipients",
          "components/sections/recipients.html"
        ),
        loadHtml("section-container-wallet", "components/sections/wallet.html"),
        loadHtml(
          "modal-container-profile-edit",
          "components/modals/profile-edit.html"
        ),
        loadHtml(
          "modal-container-password-change",
          "components/modals/password-change.html"
        ),
        loadHtml(
          "modal-container-shipment-create",
          "components/modals/shipment-create.html"
        ),
        loadHtml("modal-container-deposit", "components/modals/deposit.html"),
        loadHtml(
          "modal-container-bulk-forecast",
          "components/modals/bulk-forecast.html"
        ),
        loadHtml(
          "modal-container-claim-package",
          "components/modals/claim-package.html"
        ),
      ]).then(() => {
        // 攔截邏輯
        const originalAddEventListener = document.addEventListener;
        document.addEventListener = function (type, listener, options) {
          if (type === "DOMContentLoaded") listener();
          else originalAddEventListener.call(document, type, listener, options);
        };

        const scripts = [
          "js/apiConfig.js",
          "js/shippingData.js",
          "js/navigation.js",
          "js/dashboard-core.js",
          "js/dashboard-packages.js",
          "js/dashboard-shipments.js",
          "js/dashboard-recipient.js",
          "js/dashboard-wallet.js",
          "js/dashboard-notifications.js",
          "js/dashboard-main.js",
        ];

        const loadScript = (src) => {
          return new Promise((resolve, reject) => {
            const s = document.createElement("script");
            s.src = src;
            s.onload = resolve;
            s.onerror = reject;
            document.body.appendChild(s);
          });
        };

        (async () => {
          for (const src of scripts) {
            await loadScript(src);
          }
          // 額外綁定：認領無主件磁貼點擊
          const unclaimedTile = document.getElementById(
            "btn-claim-package-tile"
          );
          if (unclaimedTile)
            unclaimedTile.onclick = () =>
              document.getElementById("btn-claim-package")?.click();
        })();
      });
    </script>
  </body>
</html>
