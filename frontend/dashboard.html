<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <title>會員中心 | 小跑豬傢俱專線</title>
    <link rel="icon" href="assets/logo.png" type="image/png" />

    <link rel="stylesheet" href="css/theme-client.css" />
    <link rel="stylesheet" href="css/modals-unified.css" />

    <script src="js/styleLoader.js"></script>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      /* --- Dashboard 旗艦版整合樣式 --- */
      .dashboard-theme {
        background-color: #f4f7fa;
      }

      .hero-dashboard {
        background: linear-gradient(135deg, #1a73e8 0%, #003a8c 100%);
        border-radius: 24px;
        padding: 30px;
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 10px 30px rgba(26, 115, 232, 0.25);
        margin-bottom: 25px;
        position: relative;
        overflow: hidden;
      }

      .hero-dashboard::after {
        content: "\f48b";
        font-family: "Font Awesome 6 Free";
        font-weight: 900;
        position: absolute;
        right: -20px;
        bottom: -30px;
        font-size: 12rem;
        color: rgba(255, 255, 255, 0.05);
      }

      .user-welcome h2 {
        font-size: 1.8rem;
        font-weight: 800;
        margin-bottom: 8px;
      }

      .user-id-badge {
        background: #ffc107;
        color: #000;
        padding: 4px 12px;
        border-radius: 50px;
        font-size: 0.85rem;
        font-weight: 700;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
      }

      .wallet-summary-box {
        background: rgba(255, 255, 255, 0.12);
        backdrop-filter: blur(10px);
        padding: 20px 25px;
        border-radius: 18px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        text-align: right;
        min-width: 220px;
        cursor: pointer;
      }

      .ws-amount {
        font-size: 2rem;
        font-weight: 900;
        font-family: "Monaco", monospace;
      }

      .dashboard-tabs-wrapper {
        position: sticky;
        top: 70px;
        z-index: 1000;
        background: #f4f7fa;
        padding: 12px 0;
        margin-bottom: 5px;
      }

      .dashboard-tabs {
        display: flex;
        background: #e2e8f0;
        padding: 5px;
        border-radius: 16px;
        gap: 5px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      }

      .tab-btn {
        flex: 1;
        padding: 12px 5px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 800;
        cursor: pointer;
        border: none;
        background: transparent;
        color: #475569;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
      }

      .tab-btn.active {
        background: #ffffff;
        color: #1a73e8;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .dashboard-main-card {
        background: #fff;
        border-radius: 24px;
        padding: 10px;
        box-shadow: 0 4px 25px rgba(0, 0, 0, 0.05);
        min-height: 450px;
        margin-bottom: 25px;
      }

      .quick-actions-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
        margin-bottom: 25px;
      }

      .action-tile {
        background: white;
        border: 1px solid #eef1f6;
        border-radius: 20px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        transition: 0.3s;
        cursor: pointer;
      }

      .live-status-bar {
        background: white;
        border-radius: 20px;
        padding: 20px 0;
        display: flex;
        justify-content: space-around;
        align-items: center;
        margin-bottom: 25px;
        border: 1px solid #eee;
      }

      /* 新增：包裹清單結帳區 (取代原本的華麗浮動列) */
      .packages-checkout-zone {
        margin-top: 25px;
        padding: 25px;
        background: #fff;
        border: 2px solid #1a73e8;
        border-radius: 24px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
        box-shadow: 0 8px 25px rgba(26, 115, 232, 0.1);
        text-align: center;
        animation: fadeIn 0.4s ease;
      }

      .checkout-summary-text {
        font-size: 1.1rem;
        font-weight: 800;
        color: #1e293b;
      }

      .checkout-summary-text strong {
        color: #1a73e8;
        font-size: 1.5rem;
        margin: 0 5px;
      }

      .btn-execute-merging {
        width: 100%;
        max-width: 450px;
        height: 60px;
        background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
        color: white;
        border: none;
        border-radius: 16px;
        font-size: 1.15rem;
        font-weight: 900;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        box-shadow: 0 10px 20px rgba(40, 167, 69, 0.2);
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .btn-execute-merging:active {
        transform: scale(0.97);
      }

      /* 圖片上傳區樣式 */
      .upload-zone {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 140px;
        background-color: #f8fafc;
        border: 2px dashed #cbd5e1;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        color: #64748b;
      }
      .upload-zone:hover {
        background-color: #f1f5f9;
        border-color: #1a73e8;
        color: #1a73e8;
      }
      .upload-input-hidden {
        display: none;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* 行動端適配 */
      @media (max-width: 800px) {
        .hero-dashboard {
          flex-direction: column;
          text-align: center;
        }
        .wallet-summary-box {
          margin-top: 20px;
          width: 100%;
        }
        .quick-actions-grid {
          grid-template-columns: repeat(2, 1fr);
        }
        .dashboard-tabs-wrapper {
          top: 60px;
        }
        .packages-checkout-zone {
          padding: 20px 15px;
          margin-bottom: 30px; /* 留白給底部導覽 */
        }
      }
    </style>
  </head>

  <body class="dashboard-theme">
    <div class="app-layout-wrapper">
      <header class="dashboard-header">
        <div
          class="header-container"
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
          "
        >
          <a href="index.html" class="logo-link">
            <img
              src="assets/logo.png"
              alt="小跑豬集運"
              class="header-logo-img"
            />
            <span class="logo-text">小跑豬 <small>會 員 控 制 台</small></span>
          </a>

          <nav class="header-nav main-nav"></nav>

          <div class="header-right-actions">
            <div class="notification-wrapper">
              <div id="btn-notification" class="notif-trigger">
                <i class="fas fa-bell"></i>
                <span
                  id="notif-badge"
                  class="notification-badge"
                  style="display: none"
                  >0</span
                >
              </div>
              <div id="notification-dropdown" class="notification-dropdown">
                <div class="dropdown-header">
                  <span>通知中心</span>
                  <button id="btn-read-all" class="btn-text">全部已讀</button>
                </div>
                <div id="notification-list" class="dropdown-body">
                  <div class="empty-state">載入中...</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </header>

      <div class="container main-content" style="padding-top: 20px">
        <section class="hero-dashboard animate-slide-up">
          <div class="user-welcome">
            <h2 id="welcome-message">您好，載入中...</h2>
            <div
              style="
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 12px;
              "
            >
              <span class="user-id-badge" id="modal-user-id">ID: 載入中</span>
              <span style="font-size: 0.85rem; opacity: 0.8"
                ><i class="fas fa-envelope"></i>
                <span id="user-email">...</span></span
              >
            </div>
            <button
              id="btn-edit-profile"
              class="btn btn-mini"
              style="
                background: rgba(255, 255, 255, 0.15);
                border: 1px solid rgba(255, 255, 255, 0.3);
                color: #fff;
                padding: 6px 15px;
              "
            >
              <i class="fas fa-user-cog"></i> 帳號設定
            </button>
          </div>
          <div id="btn-quick-wallet" class="wallet-summary-box">
            <div class="ws-label">可用餘額 (TWD)</div>
            <div class="ws-amount" id="header-wallet-balance">0</div>
            <div
              class="ws-label"
              style="font-size: 0.7rem; margin-top: 6px; opacity: 0.8"
            >
              儲值或查看帳務 <i class="fas fa-chevron-right"></i>
            </div>
          </div>
        </section>

        <section class="live-status-bar animate-slide-up">
          <div class="status-node">
            <span class="sn-count" id="count-pending">0</span
            ><span class="sn-label">待入庫</span>
          </div>
          <div class="status-node">
            <span class="sn-count" id="count-arrived">0</span
            ><span class="sn-label">已入庫</span>
          </div>
          <div class="status-node">
            <span class="sn-count" id="count-exception">0</span
            ><span class="sn-label">異常件</span>
          </div>
          <div class="status-node">
            <span class="sn-count" id="count-unpaid">0</span
            ><span class="sn-label">待付款</span>
          </div>
        </section>

        <section class="quick-actions-grid animate-slide-up">
          <div class="action-tile" id="btn-quick-forecast">
            <div class="tile-icon"><i class="fas fa-box-open"></i></div>
            <span>預報包裹</span>
          </div>
          <div
            class="action-tile"
            onclick="document.getElementById('tab-packages').click()"
          >
            <div class="tile-icon"><i class="fas fa-shipping-fast"></i></div>
            <span>申請集運</span>
          </div>
          <div
            class="action-tile"
            onclick="location.href='furniture-procurement.html'"
          >
            <div class="tile-icon"><i class="fas fa-couch"></i></div>
            <span>傢俱代採</span>
          </div>
          <div class="action-tile" id="btn-claim-package-tile">
            <div class="tile-icon"><i class="fas fa-search-location"></i></div>
            <span>認領包裹</span>
          </div>
        </section>

        <div
          class="section-card forecast-section animate-slide-up"
          style="
            background: #fff;
            border-radius: 24px;
            padding: 25px;
            box-shadow: 0 4px 25px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
          "
        >
          <div
            class="card-header"
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 20px;
            "
          >
            <h3 style="margin: 0; font-weight: 800">
              <i
                class="fas fa-box-open"
                style="color: #1a73e8; margin-right: 10px"
              ></i
              >預報包裹
            </h3>
            <div style="display: flex; gap: 8px">
              <button
                id="btn-claim-package"
                class="btn btn-sm btn-outline-primary"
              >
                <i class="fas fa-search"></i> 認領無主件
              </button>
              <button id="btn-bulk-forecast" class="btn btn-sm btn-secondary">
                <i class="fas fa-file-excel"></i> 批量匯入
              </button>
            </div>
          </div>
          <div class="card-body">
            <form id="forecast-form">
              <div
                style="
                  display: grid;
                  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                  gap: 15px;
                "
              >
                <div class="form-group">
                  <label class="required">物流單號</label>
                  <input
                    type="text"
                    id="trackingNumber"
                    class="form-control"
                    placeholder="掃描或輸入單號"
                    required
                  />
                </div>
                <div class="form-group">
                  <label class="required">商品名稱</label>
                  <input
                    type="text"
                    id="productName"
                    class="form-control"
                    placeholder="例：書桌"
                    required
                  />
                </div>
                <div class="form-group">
                  <label>數量</label>
                  <input
                    type="number"
                    id="quantity"
                    class="form-control"
                    value="1"
                    min="1"
                  />
                </div>
              </div>
              <div class="form-group" style="margin-top: 15px">
                <label style="display: flex; justify-content: space-between">
                  <span>商品照片 (報關用)</span>
                  <span style="color: #e67e22; font-size: 12px"
                    >*照片與連結擇一填寫</span
                  >
                </label>
                <div class="upload-zone-wrapper">
                  <label
                    for="images"
                    class="upload-zone"
                    id="forecast-uploader"
                  >
                    <i class="fas fa-camera"></i>
                    <span>點擊上傳照片</span>
                  </label>
                  <input
                    type="file"
                    id="images"
                    multiple
                    accept="image/*"
                    class="upload-input-hidden"
                  />
                </div>
              </div>
              <div class="form-group" style="margin-top: 15px">
                <label>商品購買連結</label>
                <input
                  type="url"
                  id="productUrl"
                  class="form-control"
                  placeholder="請貼上商品網址 https://..."
                />
              </div>
              <div class="form-group" style="margin-top: 15px">
                <label>備註</label>
                <input
                  type="text"
                  id="note"
                  class="form-control"
                  placeholder="特殊需求..."
                />
              </div>
              <div style="text-align: right; margin-top: 20px">
                <button
                  type="submit"
                  class="btn btn-primary"
                  style="
                    padding: 12px 30px;
                    border-radius: 12px;
                    font-weight: 800;
                  "
                >
                  提交預報
                </button>
              </div>
            </form>
          </div>
        </div>

        <div class="dashboard-tabs-wrapper">
          <div class="dashboard-tabs">
            <button id="tab-packages" class="tab-btn active">
              <i class="fas fa-boxes"></i> <span>包裹</span>
            </button>
            <button id="tab-shipments" class="tab-btn">
              <i class="fas fa-file-invoice-dollar"></i> <span>集運訂單</span>
            </button>
            <button id="tab-wallet" class="tab-btn">
              <i class="fas fa-history"></i> <span>帳務</span>
            </button>
            <button id="tab-recipients" class="tab-btn">
              <i class="fas fa-users"></i> <span>收件人</span>
            </button>
            <button id="tab-unclaimed" class="tab-btn">
              <i class="fas fa-question-circle"></i> <span>無主包裹</span>
            </button>
          </div>
        </div>

        <div class="dashboard-main-card">
          <main class="dashboard-main-content">
            <div id="packages-section" class="tab-content active">
              <div id="section-container-packages"></div>
            </div>
            <div
              id="shipments-section"
              class="tab-content"
              style="display: none"
            >
              <div id="section-container-shipments"></div>
            </div>
            <div
              id="recipient-section"
              class="tab-content"
              style="display: none"
            >
              <div id="section-container-recipients"></div>
            </div>
            <div id="wallet-section" class="tab-content" style="display: none">
              <div id="section-container-wallet"></div>
            </div>
            <div
              id="unclaimed-section"
              class="tab-content"
              style="display: none"
            >
              <div class="table-responsive">
                <table class="app-table">
                  <thead>
                    <tr>
                      <th>入庫時間</th>
                      <th>物流單號</th>
                      <th>商品名稱</th>
                      <th>重量</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody id="unclaimed-table-body">
                    <tr>
                      <td colspan="5">載入中...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </main>
        </div>
      </div>
    </div>

    <nav id="mobile-bottom-nav" class="universal-bottom-nav">
      <a href="index.html" class="nav-item">
        <i class="fas fa-home"></i><span>首頁</span>
      </a>
      <a href="quote.html" class="nav-item">
        <i class="fas fa-calculator"></i><span>試算</span>
      </a>
      <a href="furniture-procurement.html" class="nav-item">
        <i class="fas fa-couch"></i><span>代採購</span>
      </a>
      <a href="dashboard.html" class="nav-item active">
        <i class="fas fa-user"></i><span>會員</span>
      </a>
    </nav>

    <div id="modal-container-profile-edit"></div>
    <div id="modal-container-password-change"></div>
    <div id="modal-container-shipment-create"></div>
    <div id="modal-container-deposit"></div>
    <div id="modal-container-bulk-forecast"></div>
    <div id="modal-container-claim-package"></div>
    <div
      id="package-details-modal"
      class="modal-overlay"
      style="display: none"
    ></div>
    <div
      id="edit-package-modal"
      class="modal-overlay"
      style="display: none"
    ></div>
    <div
      id="shipment-details-modal"
      class="modal-overlay"
      style="display: none"
    ></div>
    <div
      id="view-images-modal"
      class="modal-overlay"
      style="display: none"
    ></div>
    <div id="bank-info-modal-container"></div>

    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script>
      async function loadHtml(id, path) {
        try {
          const res = await fetch(path);
          if (res.ok) {
            const el = document.getElementById(id);
            if (el) el.innerHTML = await res.text();
          }
        } catch (e) {
          console.error(`Error loading ${path}`, e);
        }
      }

      // 載入所有 HTML 組件與彈窗
      Promise.all([
        loadHtml(
          "section-container-packages",
          "components/sections/packages.html"
        ),
        loadHtml(
          "section-container-shipments",
          "components/sections/shipments.html"
        ),
        loadHtml(
          "section-container-recipients",
          "components/sections/recipients.html"
        ),
        loadHtml("section-container-wallet", "components/sections/wallet.html"),
        loadHtml(
          "modal-container-profile-edit",
          "components/modals/profile-edit.html"
        ),
        loadHtml(
          "modal-container-password-change",
          "components/modals/password-change.html"
        ),
        loadHtml(
          "modal-container-shipment-create",
          "components/modals/shipment-create.html"
        ),
        loadHtml("modal-container-deposit", "components/modals/deposit.html"),
        loadHtml(
          "modal-container-bulk-forecast",
          "components/modals/bulk-forecast.html"
        ),
        loadHtml(
          "modal-container-claim-package",
          "components/modals/claim-package.html"
        ),
        loadHtml(
          "package-details-modal",
          "components/modals/package-details.html"
        ),
        loadHtml("edit-package-modal", "components/modals/edit-package.html"),
        loadHtml(
          "bank-info-modal-container",
          "components/modals/bank-info-modal.html"
        ),
        loadHtml(
          "shipment-details-modal",
          "components/modals/shipment-details.html"
        ),
      ]).then(() => {
        // 防止重複監聽
        const originalAddEventListener = document.addEventListener;
        document.addEventListener = function (type, listener, options) {
          if (type === "DOMContentLoaded") listener();
          else originalAddEventListener.call(document, type, listener, options);
        };

        const scripts = [
          "js/apiConfig.js",
          "js/shippingData.js",
          "js/navigation.js",
          "js/dashboard-core.js",
          "js/dashboard-packages.js",
          "js/dashboard-shipments.js",
          "js/dashboard-recipient.js",
          "js/dashboard-wallet.js",
          "js/dashboard-notifications.js",
          "js/dashboard-main.js",
        ];

        const loadScript = (src) => {
          return new Promise((resolve, reject) => {
            const s = document.createElement("script");
            s.src = src;
            s.onload = resolve;
            s.onerror = reject;
            document.body.appendChild(s);
          });
        };

        (async () => {
          for (const src of scripts) {
            await loadScript(src);
          }

          // 初始化滑動與交互
          const btnQuickForecast =
            document.getElementById("btn-quick-forecast");
          if (btnQuickForecast) {
            btnQuickForecast.onclick = () =>
              document
                .querySelector(".forecast-section")
                .scrollIntoView({ behavior: "smooth", block: "center" });
          }

          document.querySelectorAll(".tab-btn").forEach((btn) => {
            btn.addEventListener("click", () => {
              const wrapper = document.querySelector(".dashboard-tabs-wrapper");
              if (wrapper) {
                const headerOffset = 80;
                window.scrollTo({
                  top:
                    wrapper.getBoundingClientRect().top +
                    window.pageYOffset -
                    headerOffset,
                  behavior: "smooth",
                });
              }
            });
          });
        })();
      });
    </script>
    <div id="message-container"></div>
  </body>
</html>
