<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è¨‚å–®è©³ç´°å…§å®¹ / å ±é—œæ˜ç´° - å°è·‘è±¬é›†é‹</title>
    <link rel="icon" href="assets/logo.png" type="image/png" />
    <script src="js/styleLoader.js"></script>
    <style>
      :root {
        --border-color: #000;
      }

      body {
        font-family: "Microsoft JhengHei", "Heiti TC", Arial, sans-serif;
        background-color: #525659;
        margin: 0;
        padding: 20px;
        color: #000;
      }

      .page-container {
        background: white;
        width: 210mm;
        min-height: 297mm;
        margin: 0 auto;
        padding: 12mm 15mm;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
        position: relative;
        box-sizing: border-box;
      }

      @media print {
        @page {
          size: A4;
          margin: 0;
        }
        body {
          background: none;
          padding: 0;
          margin: 0;
          -webkit-print-color-adjust: exact;
          print-color-adjust: exact;
        }
        .page-container {
          width: 100%;
          min-height: 100vh;
          margin: 0;
          padding: 10mm 12mm;
          box-shadow: none;
          border: none;
        }
        .no-print {
          display: none !important;
        }
        .page-break {
          page-break-before: always;
        }
      }

      /* æ¨™é ­å€ */
      .doc-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 10px;
        margin-bottom: 15px;
      }
      .company-brand {
        display: flex;
        align-items: center;
        gap: 15px;
      }
      .company-brand img {
        height: 60px;
        filter: grayscale(100%);
      }
      .company-title h1 {
        margin: 0;
        font-size: 24px;
        letter-spacing: 2px;
        font-weight: 900;
      }
      .company-title span {
        font-size: 14px;
        font-weight: bold;
      }
      .doc-meta {
        text-align: right;
        font-size: 11px;
        line-height: 1.4;
      }
      .doc-title-box {
        text-align: center;
        margin: 10px 0;
      }
      .doc-title-box h2 {
        margin: 0;
        font-size: 22px;
        text-decoration: underline;
        text-underline-offset: 5px;
        font-weight: 900;
      }

      /* è³‡è¨Šç¶²æ ¼å€ */
      .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 10px;
        border: 1px solid var(--border-color);
        padding: 10px;
      }
      .info-column {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .info-row {
        display: flex;
        font-size: 13px;
        align-items: baseline;
      }
      .info-label {
        font-weight: bold;
        min-width: 100px;
        color: #333;
      }
      .info-value {
        flex: 1;
        border-bottom: 1px dotted #ccc;
        padding-left: 5px;
        min-height: 18px;
      }

      /* è¡¨æ ¼æ¨£å¼ */
      .standard-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 15px;
        font-size: 10px;
      }
      .standard-table th,
      .standard-table td {
        border: 1px solid var(--border-color);
        padding: 4px;
        text-align: center;
        vertical-align: middle;
      }
      .standard-table th {
        background-color: #f0f0f0;
        font-weight: bold;
      }
      .standard-table td.text-left {
        text-align: left;
      }
      .standard-table td.text-right {
        text-align: right;
      }
      .wh-remark {
        color: #d32f2f;
        font-style: italic;
        font-size: 0.9em;
      }

      /* è²»ç”¨æ˜ç´°å€åŸŸ (åŸæœ¬çš„ç¸½è¨ˆå€) */
      .totals-section {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        margin-top: -16px;
        margin-bottom: 15px;
      }
      .fee-title {
        font-size: 14px;
        font-weight: 900;
        background: #000;
        color: #fff;
        padding: 2px 15px;
        margin-right: 1px;
      }
      .totals-box {
        border: 1px solid var(--border-color);
        padding: 8px 15px;
        min-width: 250px;
        font-size: 13px;
        background: #fafafa;
      }
      .total-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 4px;
      }
      .total-row.final {
        font-weight: bold;
        font-size: 15px;
        border-top: 1px solid #000;
        padding-top: 5px;
        margin-top: 5px;
      }

      /* é™„åŠ æœå‹™å€ */
      .additional-services-box {
        border: 2px solid #000;
        padding: 8px;
        margin-bottom: 15px;
        font-size: 11px;
      }
      .services-title {
        font-weight: bold;
        margin-bottom: 6px;
        border-bottom: 1px solid #ccc;
        padding-bottom: 4px;
        display: flex;
        justify-content: space-between;
      }
      .services-list {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 8px;
      }
      .service-item {
        display: flex;
        align-items: center;
      }
      .service-checkbox {
        margin-right: 5px;
        font-size: 14px;
      }

      /* åº•éƒ¨å‚™è¨» */
      .invoice-note {
        font-size: 11px;
        color: #666;
        margin-bottom: 10px;
        font-style: italic;
      }

      .bottom-section {
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
        font-size: 13px;
      }
      .remarks-box {
        width: 60%;
        border: 1px solid var(--border-color);
        padding: 8px;
        min-height: 60px;
      }
      .signature-box {
        width: 35%;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        align-items: center;
      }
      .signature-line {
        width: 100%;
        border-bottom: 1px solid var(--border-color);
        margin-top: 20px;
        margin-bottom: 8px;
      }

      /* ç…§ç‰‡å€ */
      .photos-header {
        border-bottom: 1px solid #000;
        margin-bottom: 10px;
        padding-bottom: 4px;
        font-size: 14px;
        font-weight: bold;
      }
      .photos-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
      }
      .photo-wrapper {
        border: 1px solid #ccc;
        padding: 4px;
        text-align: center;
        page-break-inside: avoid;
      }
      .photo-wrapper img {
        width: 100%;
        height: 100px;
        object-fit: contain;
      }

      .action-bar {
        position: fixed;
        top: 20px;
        right: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 999;
      }
      .btn {
        padding: 12px 24px;
        background: #1a73e8;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .watermark {
        position: absolute;
        top: 40%;
        left: 50%;
        transform: translate(-50%, -50%) rotate(-45deg);
        font-size: 80px;
        color: rgba(0, 0, 0, 0.02);
        pointer-events: none;
        font-weight: bold;
        z-index: 0;
      }
    </style>
  </head>
  <body>
    <div class="action-bar no-print">
      <button class="btn" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°è¨‚å–®è©³ç´°å…§å®¹</button>
      <button class="btn" onclick="window.close()" style="background: #5f6368">
        é—œé–‰è¦–çª—
      </button>
    </div>

    <div
      id="loading"
      style="text-align: center; color: white; margin-top: 100px"
    >
      æ­£åœ¨ç”¢ç”Ÿå ±åƒ¹å ±å‘Šèˆ‡æ˜ç´°...
    </div>

    <div id="print-content" class="page-container" style="display: none">
      <div class="watermark">RUNPIGGY REPORT</div>

      <div class="doc-header">
        <div class="company-brand">
          <img src="assets/logo.png" alt="Logo" />
          <div class="company-title">
            <h1>å°è·‘è±¬é›†é‹</h1>
            <span>RUNPIGGY INTERNATIONAL LOGISTICS</span>
          </div>
        </div>
        <div class="doc-meta">
          <div>å®˜æ–¹ç¶²ç«™ï¼šrunpiggy.com</div>
          <div>å®¢æœ LINE: @runpiggy</div>
          <div>åˆ—å°æ™‚é–“: <span id="print-date"></span></div>
        </div>
      </div>

      <div class="doc-title-box">
        <h2>è¨‚å–®è©³ç´°å…§å®¹ / PACKING LIST</h2>
      </div>

      <div class="info-grid">
        <div class="info-column">
          <div class="info-row">
            <span class="info-label">é›†é‹å–®è™Ÿï¼š</span>
            <span class="info-value" id="p-id" style="font-weight: bold"></span>
          </div>
          <div class="info-row">
            <span class="info-label">å»ºç«‹æ—¥æœŸï¼š</span>
            <span class="info-value" id="p-date"></span>
          </div>
          <div class="info-row">
            <span class="info-label">è¨‚å–®ç‹€æ…‹ï¼š</span>
            <span class="info-value" id="p-status"></span>
          </div>
          <div class="info-row">
            <span class="info-label">ç‰©æµè¿½è¹¤ç¢¼ï¼š</span>
            <span class="info-value" id="p-tw-tracking"></span>
          </div>
        </div>
        <div class="info-column">
          <div class="info-row">
            <span class="info-label">æ”¶ä»¶äººï¼š</span>
            <span class="info-value" id="p-name"></span>
          </div>
          <div class="info-row">
            <span class="info-label">è¯çµ¡é›»è©±ï¼š</span>
            <span class="info-value" id="p-phone"></span>
          </div>
          <div class="info-row">
            <span class="info-label">èº«åˆ†è­‰è™Ÿï¼š</span>
            <span class="info-value" id="p-idnum"></span>
          </div>
          <div class="info-row">
            <span class="info-label">é…é€åœ°å€ï¼š</span>
            <span class="info-value" id="p-address"></span>
          </div>
        </div>
      </div>

      <div
        id="invoice-section"
        class="info-grid"
        style="display: none; border-top: none; margin-top: -11px"
      >
        <div class="info-column">
          <div class="info-row">
            <span class="info-label">ç™¼ç¥¨çµ±ç·¨ï¼š</span>
            <span class="info-value" id="p-tax-id">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">ç™¼ç¥¨æŠ¬é ­ï¼š</span>
            <span class="info-value" id="p-invoice-title">-</span>
          </div>
        </div>
        <div class="info-column">
          <div class="info-row">
            <span class="info-label">ç™¼ç¥¨è™Ÿç¢¼ï¼š</span>
            <span class="info-value" id="p-invoice-num">å°šæœªé–‹ç«‹</span>
          </div>
          <div class="info-row" style="font-size: 10px; color: #666">
            â€» é»˜èªé–‹ç«‹é›»å­ç™¼ç¥¨è‡³å¸³è™Ÿè¨­å®šä¹‹é›»å­ä¿¡ç®±
          </div>
        </div>
      </div>

      <table class="standard-table">
        <thead>
          <tr>
            <th style="width: 3%">#</th>
            <th style="width: 15%">ç‰©æµå–®è™Ÿ</th>
            <th style="width: 25%">å•†å“åç¨±/è³¼è²·ç¶²å€</th>
            <th style="width: 18%">å‹è™Ÿèˆ‡è¦æ ¼</th>
            <th style="width: 5%">æ•¸é‡</th>
            <th style="width: 12%">é‡é‡(KG)</th>
            <th style="width: 22%">å‚™è¨» (Warehouse Remark)</th>
          </tr>
        </thead>
        <tbody id="p-pkg-body"></tbody>
      </table>

      <div class="totals-section">
        <div class="fee-title">è²»ç”¨æ˜ç´°</div>
        <div class="totals-box">
          <div class="total-row">
            <span>å…¥åº«ç¸½ç®±æ•¸ï¼š</span>
            <span id="p-total-boxes">0 ç®±</span>
          </div>
          <div class="total-row">
            <span>æ ¸å®šç¸½å¯¦é‡ï¼š</span>
            <span id="p-total-weight">0.0 kg</span>
          </div>
          <div class="total-row">
            <span>æ ¸å®šç¸½æç©ï¼š</span>
            <span id="p-total-cai">0.0 æ</span>
          </div>
          <div class="total-row final">
            <span>æ‡‰ä»˜é‹è²»ç¸½è¨ˆï¼š</span>
            <span id="p-total-cost">NT$ 0</span>
          </div>
        </div>
      </div>

      <div
        id="p-services-section"
        class="additional-services-box"
        style="display: none"
      >
        <div class="services-title">
          <span>ğŸ› ï¸ é™„åŠ æœå‹™æ˜ç´° (Additional Services)</span>
          <span style="font-weight: normal; font-size: 10px"
            >â€» æ­¤è²»ç”¨ç”±å®¢æˆ¶ç›´æ¥ç¾å ´æ”¯ä»˜çµ¦å¸æ©Ÿ</span
          >
        </div>
        <div id="p-services-list" class="services-list"></div>
        <div
          style="
            margin-top: 5px;
            text-align: center;
            border-top: 1px dashed #ccc;
            padding-top: 5px;
            font-weight: bold;
            color: #d32f2f;
            font-size: 10px;
          "
        >
          âš ï¸ æé†’ï¼šå› æ¯å€‹ç¤¾å€ç®¡ç†æ–¹å¼èˆ‡ä¸­åº­è·é›¢ä¸åŒ,
          å¯¦éš›é‡‘é¡ä¾å¸æ©Ÿç¾å ´å ±åƒ¹ç‚ºä¸»ã€‚
        </div>
      </div>

      <div class="bottom-section">
        <div class="remarks-box">
          <strong>å®¢æˆ¶ç•™è¨€ / Order Remarks:</strong><br />
          <span
            id="p-note"
            style="white-space: pre-wrap; color: #444; font-size: 11px"
          ></span>
        </div>
        <div class="signature-box">
          <div class="signature-line"></div>
          <div>æ”¶ä»¶äººç°½æ”¶è“‹ç«  / Signature</div>
        </div>
      </div>

      <div class="page-break"></div>

      <div class="photos-section" id="photo-section" style="margin-top: 20px">
        <div class="photos-header">
          ğŸ“· è²¨ç‰©å…¥åº«ç…§ç‰‡å­˜æŸ¥è¨˜éŒ„ (Warehouse Photos)
        </div>
        <div class="photos-grid" id="p-photos-grid"></div>
      </div>
    </div>

    <script src="js/apiConfig.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const params = new URLSearchParams(window.location.search);
        const shipmentId = params.get("id");
        const adminToken = localStorage.getItem("admin_token");
        const clientToken = localStorage.getItem("token");
        const isPrivileged = !!adminToken;
        const token = adminToken || clientToken;

        if (!shipmentId || !token) {
          alert("é€£çµå¤±æ•ˆæˆ–æ¬Šé™ä¸è¶³");
          window.close();
          return;
        }

        try {
          const response = await fetch(
            `${API_BASE_URL}/api/shipments/${shipmentId}`,
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );
          const data = await response.json();
          if (!response.ok) throw new Error(data.message);

          renderShipment(data.shipment, isPrivileged);

          document.getElementById("loading").style.display = "none";
          document.getElementById("print-content").style.display = "block";

          const now = new Date();
          document.getElementById("print-date").textContent =
            now.toLocaleString();
        } catch (error) {
          document.getElementById(
            "loading"
          ).innerHTML = `<span style="color:red">è¼‰å…¥å¤±æ•—: ${error.message}</span>`;
        }
      });

      function formatSensitive(str, type, isPrivileged) {
        if (!str) return "-";
        if (isPrivileged) return str;
        if (type === "phone")
          return str.substring(0, 4) + "****" + str.substring(str.length - 2);
        if (type === "id")
          return str.substring(0, 1) + "*********" + str.slice(-1);
        return str;
      }

      function renderShipment(ship, isPrivileged) {
        // åŸºæœ¬è³‡è¨Š (å„ªå…ˆé¡¯ç¤ºè‡ªå®šç¾©å–®è™Ÿ)
        document.getElementById("p-id").textContent = (
          ship.shipmentNo || ship.id
        ).toUpperCase();
        document.getElementById("p-date").textContent = new Date(
          ship.createdAt
        ).toLocaleDateString();

        const statusMap = {
          PENDING_PAYMENT: "å¾…ä»˜æ¬¾",
          PROCESSING: "å·²ä»˜æ¬¾/è™•ç†ä¸­",
          SHIPPED: "å·²è£æ«ƒå‡ºè²¨",
          COMPLETED: "å·²å®Œæˆ",
        };
        document.getElementById("p-status").textContent =
          statusMap[ship.status] || ship.status;

        // å°ç£è¿½è¹¤ç¢¼å„ªåŒ–
        document.getElementById("p-tw-tracking").textContent =
          ship.trackingNumberTW || "å°ˆè»Šæ´¾é€";

        // æ”¶ä»¶äºº
        document.getElementById("p-name").textContent = ship.recipientName;
        document.getElementById("p-phone").textContent = formatSensitive(
          ship.phone,
          "phone",
          isPrivileged
        );
        document.getElementById("p-idnum").textContent = formatSensitive(
          ship.idNumber,
          "id",
          isPrivileged
        );
        document.getElementById("p-address").textContent = ship.shippingAddress;
        document.getElementById("p-note").textContent = ship.note || "ç„¡";

        // ç™¼ç¥¨å€
        if (ship.taxId || ship.invoiceTitle || ship.invoiceNumber) {
          document.getElementById("invoice-section").style.display = "grid";
          document.getElementById("p-tax-id").textContent = ship.taxId || "-";
          document.getElementById("p-invoice-title").textContent =
            ship.invoiceTitle || "-";
          document.getElementById("p-invoice-num").textContent =
            ship.invoiceNumber || "å°šæœªé–‹ç«‹";
        }

        // é™„åŠ æœå‹™æ¸…å–® (æ ¹æ“šåŒäº‹éœ€æ±‚æ“´å……)
        const svcs = ship.additionalServices || {};
        const svcList = document.getElementById("p-services-list");
        let svcHtml = "";
        let hasSvc = false;

        const allSvcKeys = [
          { key: "floor_stairs", label: "æ¬é‹ä¸Šæ¨“(æ¨“æ¢¯)" },
          { key: "floor_elevator", label: "æ¬é‹ä¸Šæ¨“(é›»æ¢¯)" },
          { key: "wood_strip", label: "æ‹†æœ¨æ¶" },
          { key: "wood_strip_recycle", label: "æ‹†æœ¨æ¶&å›æ”¶" },
          { key: "wrap_wood", label: "æ‰“æœ¨æ¶(åŠ å¼·)" },
          { key: "wrap_bubble", label: "æ°£æ³¡è†œ" },
          { key: "floor", label: "æ¬é‹ä¸Šæ¨“" }, // å…¼å®¹èˆŠè³‡æ–™
          { key: "wood", label: "æœ¨æ¶è™•ç†" }, // å…¼å®¹èˆŠè³‡æ–™
        ];

        allSvcKeys.forEach((item) => {
          const data = svcs[item.key];
          if (data && data.selected) {
            hasSvc = true;
            svcHtml += `<div class="service-item"><span class="service-checkbox">â˜‘</span> <strong>${
              item.label
            }</strong> ${data.note ? `(${data.note})` : ""}</div>`;
          } else {
            svcHtml += `<div class="service-item" style="opacity:0.3"><span class="service-checkbox">â˜</span> ${item.label}</div>`;
          }
        });

        if (hasSvc) {
          svcList.innerHTML = svcHtml;
          document.getElementById("p-services-section").style.display = "block";
        }

        // åŒ…è£¹è¡¨æ ¼èˆ‡ç…§ç‰‡ (å«é›»å™¨å‹è™Ÿè¦æ ¼)
        const tbody = document.getElementById("p-pkg-body");
        const photosGrid = document.getElementById("p-photos-grid");
        let totalBoxes = 0,
          totalW = 0,
          totalC = 0,
          totalQty = 0;

        ship.packages.forEach((pkg, idx) => {
          const tr = document.createElement("tr");
          let pkgW = 0,
            pkgC = 0,
            boxes = 0;

          if (pkg.arrivedBoxes && pkg.arrivedBoxes.length > 0) {
            pkgW = pkg.arrivedBoxes.reduce(
              (acc, b) => acc + (parseFloat(b.weight) || 0),
              0
            );
            pkgC = pkg.arrivedBoxes.reduce(
              (acc, b) => acc + (parseFloat(b.cai) || 0),
              0
            );
            boxes = pkg.arrivedBoxes.length;
          }

          totalBoxes += boxes;
          totalW += pkgW;
          totalC += pkgC;
          totalQty += pkg.quantity;

          // å•†å“èˆ‡é€£çµ
          let productDesc = `<b>${pkg.productName}</b>`;
          if (pkg.productUrl)
            productDesc += `<br><span style="color:#1a73e8; font-size:8px;">URL: ${pkg.productUrl.substring(
              0,
              40
            )}...</span>`;

          // å‹è™Ÿè¦æ ¼
          let modelSpec = `${pkg.modelNumber || "-"} / ${pkg.spec || "-"}`;

          tr.innerHTML = `
            <td>${idx + 1}</td>
            <td style="font-family:monospace;">${pkg.trackingNumber}</td>
            <td class="text-left">${productDesc}</td>
            <td class="text-left">${modelSpec}</td>
            <td>${pkg.quantity}</td>
            <td>${pkgW.toFixed(1)}<br><small>(${boxes}ç®±)</small></td>
            <td class="text-left">${pkg.note || ""} ${
            pkg.warehouseRemark
              ? `<br><span class="wh-remark">[å€‰] ${pkg.warehouseRemark}</span>`
              : ""
          }</td>
          `;
          tbody.appendChild(tr);

          // ç…§ç‰‡å±•ç¤º
          const imgs = [
            ...(pkg.productImages || []),
            ...(pkg.warehouseImages || []),
          ];
          imgs.forEach((url) => {
            const div = document.createElement("div");
            div.className = "photo-wrapper";
            // ä¿®æ­£ Cloudinary æˆ–æœ¬åœ°è·¯å¾‘
            const src = url.startsWith("http") ? url : `${API_BASE_URL}${url}`;
            div.innerHTML = `<img src="${src}"><div style="font-size:8px; margin-top:2px;">${pkg.productName}</div>`;
            photosGrid.appendChild(div);
          });
        });

        // æ›´æ–°çµ±è¨ˆ
        document.getElementById(
          "p-total-boxes"
        ).textContent = `${totalBoxes} ç®±`;
        document.getElementById(
          "p-total-weight"
        ).textContent = `${totalW.toFixed(1)} kg`;
        document.getElementById("p-total-cai").textContent = `${totalC.toFixed(
          2
        )} æ`;
        document.getElementById("p-total-cost").textContent = `NT$ ${(
          ship.totalCost || 0
        ).toLocaleString()}`;

        if (photosGrid.children.length === 0)
          document.getElementById("photo-section").style.display = "none";
      }
    </script>
  </body>
</html>
