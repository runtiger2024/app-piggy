<div id="create-shipment-modal" class="modal-overlay" style="display: none">
  <div class="modal-content modal-lg checkout-modal">
    <button class="modal-close">&times;</button>
    <div
      class="modal-header"
      style="
        border-bottom: 1px solid #eee;
        margin-bottom: 15px;
        padding-bottom: 10px;
      "
    >
      <h3><i class="fas fa-boxes"></i> 確認訂單 (合併打包)</h3>
    </div>
    <form id="create-shipment-form">
      <div class="checkout-layout">
        <div class="checkout-items">
          <h4
            style="
              margin-top: 0;
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            📦 包裹清單
            <span style="font-size: 13px; color: #666; font-weight: normal"
              >已選 <span id="checkout-total-count">0</span> 件</span
            >
          </h4>

          <div
            id="shipment-package-list"
            style="
              max-height: 250px;
              overflow-y: auto;
              margin-bottom: 15px;
              border: 1px solid #eee;
              border-radius: 4px;
              background: #fafafa;
            "
          ></div>

          <div
            class="cost-calculation-box"
            style="
              background: #f8f9fa;
              padding: 15px;
              border-radius: 8px;
              border: 1px solid #e9ecef;
            "
          >
            <h5
              style="
                margin: 0 0 10px 0;
                color: #2c3e50;
                font-weight: bold;
                border-bottom: 2px solid #ddd;
                padding-bottom: 5px;
              "
            >
              💰 費用明細
            </h5>

            <div
              id="weight-analysis-panel"
              style="
                margin-bottom: 12px;
                padding-bottom: 12px;
                border-bottom: 1px dashed #ccc;
                font-size: 13px;
              "
            >
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  margin-bottom: 4px;
                "
              >
                <span>總實重 (Actual Weight):</span>
                <span id="calc-actual-weight" style="font-weight: 500"
                  >-- kg</span
                >
              </div>
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  margin-bottom: 4px;
                "
              >
                <span>總材積 (Volumetric):</span>
                <span id="calc-volumetric" style="font-weight: 500">-- 材</span>
              </div>
              <div
                style="
                  background: #e3f2fd;
                  padding: 5px 8px;
                  border-radius: 4px;
                  color: #0d47a1;
                  margin-top: 5px;
                  font-size: 12px;
                  border-left: 3px solid #1976d2;
                "
              >
                <i class="fas fa-info-circle"></i> <strong>計費說明：</strong>
                取每箱「實重」與「材積重」較高者計算運費。
              </div>
            </div>

            <div id="api-fee-breakdown">
              <div style="text-align: center; color: #999; padding: 10px">
                <div
                  class="spinner"
                  style="width: 20px; height: 20px; display: inline-block"
                ></div>
                正在雲端精算運費...
              </div>
            </div>
          </div>
        </div>

        <div class="checkout-info-form">
          <div
            id="forklift-warning"
            class="alert alert-danger"
            style="
              display: none;
              margin-bottom: 15px;
              font-size: 13px;
              color: red;
              font-weight: bold;
            "
          >
            <i class="fas fa-dolly"></i>
            <strong>超重提醒：</strong> 偵測到單件 > 100kg 包裹。<br />
            請確認台灣收件地址可<strong>自行安排堆高機</strong>下貨，否則司機可能無法派送。
          </div>

          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <h4>📝 收件資訊</h4>
            <button
              type="button"
              id="btn-select-recipient"
              class="btn btn-sm btn-outline-primary"
              style="width: auto; padding: 4px 10px"
            >
              <i class="fas fa-address-book"></i> 常用地址
            </button>
          </div>

          <div class="form-group">
            <label class="required">收件人</label
            ><input
              type="text"
              id="ship-name"
              class="form-control"
              placeholder="真實姓名"
              required
            />
          </div>
          <div class="form-group">
            <label class="required">電話</label
            ><input
              type="tel"
              id="ship-phone"
              class="form-control"
              placeholder="收件人聯絡電話"
              required
            />
          </div>

          <div class="form-group">
            <label class="required">配送地區</label>
            <div style="display: flex; gap: 5px; margin-bottom: 5px">
              <input
                type="text"
                id="ship-area-search"
                placeholder="搜尋地區 (例：板橋)..."
                class="form-control"
                style="flex: 1"
              />
              <div id="ship-search-results" class="search-dropdown"></div>
            </div>
            <select id="ship-delivery-location" class="form-control" required>
              <option value="" selected disabled>
                --- 正在讀取配送地區 ---
              </option>
            </select>
            <div
              id="ship-remote-area-info"
              style="
                display: none;
                background: #fff3e0;
                color: #e65100;
                padding: 8px;
                margin-top: 5px;
                border-radius: 4px;
                font-size: 13px;
                border: 1px solid #ffe0b2;
              "
            >
              <i class="fas fa-map-marker-alt"></i>
              <strong>偏遠地區加價：</strong><br />
              選定地區：<span
                id="ship-selected-area-name"
                style="font-weight: bold"
              ></span>
              <br />
              加收費率：<span
                id="ship-selected-area-fee"
                style="font-weight: bold; color: #d32f2f"
              ></span>
              / 材
            </div>
          </div>

          <div class="form-group">
            <label class="required">詳細地址</label
            ><input
              type="text"
              id="ship-street-address"
              class="form-control"
              placeholder="路 / 街 / 號 / 樓層"
              required
            />
          </div>

          <div class="form-group">
            <label class="required">身分證字號 (報關用)</label
            ><input
              type="text"
              id="ship-idNumber"
              class="form-control"
              placeholder="第一個字母大寫 + 9 位數字 (第一位為1或2)"
              maxlength="10"
              required
            />
          </div>

          <div
            class="form-section"
            style="
              margin-top: 15px;
              padding-top: 10px;
              border-top: 1px solid #eee;
            "
          >
            <h4 style="margin-bottom: 10px; color: #2c3e50">🛠️ 附加服務</h4>

            <div
              class="alert alert-field-pay"
              style="
                background: #fffde7;
                color: #856404;
                padding: 10px;
                border-radius: 8px;
                font-size: 12px;
                line-height: 1.5;
                border: 1px solid #fff9c4;
                margin-bottom: 10px;
              "
            >
              <i class="fas fa-hand-holding-usd"></i>
              <strong>現場支付聲明：</strong><br />
              此處勾選之服務費用由客戶直接現場支付給現場派送人員。因每個社區管理方式與中庭距離不同,
              實際金額依司機現場報價為主。
            </div>

            <div id="shipment-services-container">
              <div style="color: #999; font-size: 13px; padding: 5px 0">
                <i class="fas fa-sync fa-spin"></i> 正在載入可用服務...
              </div>
            </div>
          </div>

          <div
            class="form-section"
            style="
              margin-top: 15px;
              border-top: 1px solid #eee;
              padding-top: 10px;
            "
          >
            <h4 style="margin-bottom: 10px; color: #2c3e50">💳 付款方式</h4>
            <div style="display: flex; gap: 15px; margin-bottom: 10px">
              <label
                style="
                  cursor: pointer;
                  display: flex;
                  align-items: center;
                  gap: 5px;
                "
              >
                <input
                  type="radio"
                  name="paymentMethod"
                  id="pay-transfer"
                  value="TRANSFER"
                  checked
                  onchange="togglePaymentMethod('TRANSFER')"
                />
                <span>銀行轉帳</span>
              </label>
              <label
                style="
                  cursor: pointer;
                  display: flex;
                  align-items: center;
                  gap: 5px;
                "
              >
                <input
                  type="radio"
                  name="paymentMethod"
                  id="pay-wallet"
                  value="WALLET"
                  onchange="togglePaymentMethod('WALLET')"
                />
                <span>錢包餘額</span>
              </label>
            </div>
            <div
              id="wallet-pay-info"
              style="
                display: none;
                background: #e8f5e9;
                padding: 10px;
                border-radius: 5px;
                font-size: 13px;
                color: #2e7d32;
              "
            >
              正在檢查餘額...
            </div>

            <div
              class="invoice-remark"
              style="
                margin-top: 10px;
                font-size: 12px;
                color: #666;
                background: #f1f3f5;
                padding: 8px;
                border-radius: 6px;
              "
            >
              <i class="fas fa-file-invoice"></i> <strong>發票開立說明：</strong
              ><br />
              默認開立電子發票至帳號設定中填寫的電子信箱。若需統編請於付款憑證上傳時填寫。
            </div>
          </div>

          <div class="form-group" style="margin-top: 15px">
            <label>訂單備註</label
            ><input
              type="text"
              id="ship-note"
              class="form-control"
              placeholder="有任何特殊裝載需求請備註於此"
            />
          </div>
        </div>
      </div>

      <div class="modal-footer sticky-footer-actions">
        <button type="button" class="btn btn-secondary modal-close-btn">
          取消重選
        </button>
        <button type="submit" class="btn btn-primary btn-place-order">
          <i class="fas fa-paper-plane"></i> 提交集運訂單
        </button>
      </div>
    </form>
  </div>
</div>
