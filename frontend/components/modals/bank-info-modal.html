<div
  id="bank-info-modal"
  class="modal-overlay"
  style="display: none; z-index: 9999"
>
  <div
    class="modal-content"
    style="z-index: 10000; position: relative; max-width: 500px; width: 95%"
  >
    <div
      class="modal-header"
      style="border-bottom: 1px solid #eee; padding-bottom: 10px"
    >
      <h3><i class="fas fa-university"></i> 訂單已建立！請完成轉帳</h3>
    </div>

    <div class="modal-body" style="padding: 20px 0">
      <div
        class="alert alert-info"
        style="
          background: #e3f2fd;
          color: #0d47a1;
          padding: 10px;
          border-radius: 5px;
          font-size: 13px;
          margin-bottom: 15px;
        "
      >
        <i class="fas fa-envelope-open-text"></i>
        訂單通知信已同步發送，若沒看到請檢查<strong>「垃圾郵件」</strong>匣。
      </div>

      <div
        style="
          background: #f8f9fa;
          padding: 15px;
          border-radius: 8px;
          border: 1px solid #dee2e6;
          margin-bottom: 20px;
        "
      >
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
          "
        >
          <span style="font-size: 14px; color: #666">銀行名稱</span>
          <div>
            <strong id="bank-name-display" style="margin-right: 10px"
              >--</strong
            >
            <button
              type="button"
              class="btn-copy"
              onclick="copyText('bank-name-display')"
            >
              複製
            </button>
          </div>
        </div>
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
          "
        >
          <span style="font-size: 14px; color: #666">轉帳帳號</span>
          <div>
            <strong
              id="bank-account-display"
              style="margin-right: 10px; color: #d32f2f; font-family: monospace"
              >--</strong
            >
            <button
              type="button"
              class="btn-copy"
              onclick="copyText('bank-account-display')"
            >
              複製
            </button>
          </div>
        </div>
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <span style="font-size: 14px; color: #666">戶名</span>
          <div>
            <strong id="bank-holder-display" style="margin-right: 10px"
              >--</strong
            >
            <button
              type="button"
              class="btn-copy"
              onclick="copyText('bank-holder-display')"
            >
              複製
            </button>
          </div>
        </div>

        <div
          id="bank-invoice-note"
          style="
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px dashed #ccc;
            font-size: 11px;
            color: #666;
          "
        >
          <i class="fas fa-info-circle"></i>
          備註：默認開立電子發票至帳號設定中填寫的電子信箱
        </div>
      </div>

      <div
        class="invoice-info-section"
        style="
          margin-bottom: 20px;
          padding: 15px;
          background: #fff9f0;
          border-radius: 8px;
          border: 1px solid #ffe8cc;
        "
      >
        <h4 style="margin: 0 0 10px 0; font-size: 15px; color: #e67e22">
          <i class="fas fa-file-invoice"></i> 發票開立資訊 (選填)
        </h4>
        <div class="form-group" style="margin-bottom: 10px">
          <label
            style="
              font-size: 13px;
              color: #666;
              display: block;
              margin-bottom: 4px;
            "
            >統一編號</label
          >
          <input
            type="text"
            id="bank-tax-id"
            class="form-control"
            placeholder="若需開立統編請在此填寫"
            maxlength="8"
            oninput="handleTaxIdChange(this)"
            style="
              width: 100%;
              padding: 8px;
              border: 1px solid #ddd;
              border-radius: 4px;
            "
          />
        </div>
        <div class="form-group">
          <label
            id="label-invoice-title"
            style="
              font-size: 13px;
              color: #666;
              display: block;
              margin-bottom: 4px;
            "
          >
            公司抬頭
            <span id="title-required-star" style="color: red; display: none"
              >* 必填</span
            >
          </label>
          <input
            type="text"
            id="bank-invoice-title"
            class="form-control"
            placeholder="填寫統編時，公司抬頭為必填"
            style="
              width: 100%;
              padding: 8px;
              border: 1px solid #ddd;
              border-radius: 4px;
            "
          />
        </div>
      </div>

      <div class="form-group">
        <label
          style="
            font-weight: bold;
            margin-bottom: 10px;
            display: block;
            font-size: 14px;
          "
        >
          <i class="fas fa-camera"></i> 立即上傳轉帳憑證 (選填)
        </label>
        <div class="upload-zone-wrapper">
          <label
            for="bank-transfer-proof"
            class="upload-zone"
            id="bank-proof-label"
          >
            <i class="fas fa-camera"></i>
            <span>點擊選擇憑證照片</span>
            <small style="display: block; margin-top: 4px; opacity: 0.7"
              >支持 JPG, PNG 格式</small
            >
          </label>
          <input
            type="file"
            id="bank-transfer-proof"
            accept="image/*"
            class="upload-input-hidden"
            onchange="handleBankProofPreview(this)"
          />
        </div>

        <div
          id="bank-proof-preview-container"
          style="display: none; margin-top: 15px; text-align: center"
        >
          <img
            id="bank-proof-preview-img"
            src=""
            style="
              max-width: 100%;
              max-height: 200px;
              border-radius: 8px;
              border: 2px solid #e2e8f0;
            "
          />
          <div style="margin-top: 8px">
            <button
              type="button"
              class="btn btn-sm btn-outline-danger"
              onclick="resetBankProofUpload()"
              style="font-size: 11px; padding: 4px 12px"
            >
              <i class="fas fa-trash"></i> 刪除並重選
            </button>
          </div>
        </div>
      </div>
    </div>

    <div
      class="modal-footer"
      style="
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        border-top: 1px solid #eee;
        padding-top: 15px;
      "
    >
      <button
        class="btn btn-secondary"
        onclick="document.getElementById('bank-info-modal').style.display='none'"
      >
        稍後再傳
      </button>
      <button
        id="btn-bank-submit-proof"
        class="btn btn-primary"
        onclick="submitBankProof()"
        disabled
      >
        <i class="fas fa-check-circle"></i> 確認提交憑證
      </button>
    </div>
  </div>
</div>

<style>
  /* 複製按鈕基礎樣式 */
  .btn-copy {
    background: #fff;
    border: 1px solid #ccc;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    cursor: pointer;
  }
  .btn-copy:hover {
    background: #eee;
  }

  /* 上傳區現代化樣式 */
  .upload-zone-wrapper {
    position: relative;
    width: 100%;
  }
  .upload-zone {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 140px;
    background-color: #f8fafc;
    border: 2px dashed #cbd5e1;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    color: #64748b;
  }
  .upload-zone:hover {
    background-color: #f1f5f9;
    border-color: #1a73e8;
    color: #1a73e8;
  }
  .upload-zone i {
    font-size: 2.2rem;
    margin-bottom: 10px;
  }
  .upload-zone span {
    font-size: 14px;
    font-weight: 600;
  }
  .upload-input-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    border: 0;
  }
</style>

<script>
  /**
   * 監聽統編輸入：有填寫時標記抬頭為必填
   */
  function handleTaxIdChange(input) {
    const star = document.getElementById("title-required-star");
    if (star) {
      star.style.display = input.value.trim().length > 0 ? "inline" : "none";
    }
  }

  /**
   * 圖片預覽處理邏輯
   */
  function handleBankProofPreview(input) {
    const container = document.getElementById("bank-proof-preview-container");
    const img = document.getElementById("bank-proof-preview-img");
    const label = document.getElementById("bank-proof-label");
    const submitBtn = document.getElementById("btn-bank-submit-proof");

    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function (e) {
        if (img) img.src = e.target.result;
        if (container) container.style.display = "block";
        if (label) label.style.display = "none";
        if (submitBtn) submitBtn.disabled = false; // 選中圖片後啟用
      };
      reader.readAsDataURL(input.files[0]);
    }
  }

  /**
   * 重置上傳區域狀態
   */
  function resetBankProofUpload() {
    const input = document.getElementById("bank-transfer-proof");
    const container = document.getElementById("bank-proof-preview-container");
    const label = document.getElementById("bank-proof-label");
    const submitBtn = document.getElementById("btn-bank-submit-proof");
    const taxInput = document.getElementById("bank-tax-id");
    const titleInput = document.getElementById("bank-invoice-title");
    const star = document.getElementById("title-required-star");

    if (input) input.value = "";
    if (container) container.style.display = "none";
    if (label) label.style.display = "flex";
    if (submitBtn) submitBtn.disabled = true;
    if (taxInput) taxInput.value = "";
    if (titleInput) titleInput.value = "";
    if (star) star.style.display = "none";
  }

  /**
   * 提交憑證邏輯 (含驗證與發票欄位)
   */
  async function submitBankProof() {
    const shipmentId = window.lastCreatedShipmentId;
    const fileInput = document.getElementById("bank-transfer-proof");
    const file = fileInput ? fileInput.files[0] : null;

    const taxId = document.getElementById("bank-tax-id").value.trim();
    const invoiceTitle = document
      .getElementById("bank-invoice-title")
      .value.trim();

    if (!shipmentId) return alert("系統錯誤：找不到訂單單號");
    if (!file) return alert("請先選擇照片");

    // 必填校驗：填寫統編時抬頭不可為空
    if (taxId.length > 0 && invoiceTitle.length === 0) {
      alert("⚠️ 提醒：填寫統一編號時，公司抬頭為必填項目");
      const titleInput = document.getElementById("bank-invoice-title");
      if (titleInput) titleInput.focus();
      return;
    }

    const btn = document.getElementById("btn-bank-submit-proof");
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 上傳中...';

    const fd = new FormData();
    fd.append("paymentProof", file); // 與後端 shipmentController 對應
    fd.append("taxId", taxId);
    fd.append("invoiceTitle", invoiceTitle);

    try {
      // 呼叫更新憑證 API
      const res = await fetch(
        `${API_BASE_URL}/api/shipments/${shipmentId}/payment`,
        {
          method: "PUT",
          headers: { Authorization: `Bearer ${window.dashboardToken}` },
          body: fd,
        }
      );

      if (res.ok) {
        alert("憑證與發票資訊上傳成功！管理員將儘速審核訂單。");
        document.getElementById("bank-info-modal").style.display = "none";
        // 觸發外部列表更新
        if (typeof window.loadMyShipments === "function")
          window.loadMyShipments();
      } else {
        const data = await res.json();
        alert(data.message || "上傳失敗，請稍後再試");
      }
    } catch (err) {
      alert("網路連線錯誤，請檢查您的網路狀態");
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-check-circle"></i> 確認提交憑證';
    }
  }
</script>
