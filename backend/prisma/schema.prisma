// backend/prisma/schema.prisma
// V16.0 - 旗艦整合版：支援 LINE 登入並行與訊息推播功能 (新增 lineUserId)

generator client {
  provider = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
  // 這裡不可以有 url，否則 Prisma 7 會報錯 P1012
}

// --- 1. 會員 (客戶) 資料模型 ---
model User {
  id                  String   @id @default(cuid())
  
  // 專屬會員標識碼：格式為 RP0000889
  piggyId              String?  @unique
  
  email                String   @unique
  
  // [修改] passwordHash 改為可選，因為 LINE 快速註冊的使用者初期可能沒有密碼
  passwordHash         String?
  
  name                 String?
  phone                String?
  defaultAddress       String?

  // [新增] LINE 相關欄位：用於辨識 LINE 客戶與執行後續訊息推播
  lineUserId           String?  @unique

  // 發票預設資料
  defaultTaxId         String?
  defaultInvoiceTitle String?

  // 權限控制
  permissions          Json     @default("[]")

  // 帳號狀態
  isActive            Boolean  @default(true)

  // 忘記密碼欄位
  resetPasswordToken  String?
  resetPasswordExpire DateTime?

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // 關聯
  packages            Package[]
  shipments            Shipment[]
  activityLogs        ActivityLog[]
  recipients          Recipient[]
  wallet              Wallet?
  notifications        Notification[]
  
  // 家具代採購關聯
  furnitureOrders      FurnitureOrder[]
}

// --- 2. 包裹 (預報) 資料模型 ---
model Package {
  id                  String   @id @default(cuid())
  trackingNumber      String   @unique
  productName          String
  quantity            Int      @default(1)
  note                String?
  
  productUrl          String?   

  productImages        Json     @default("[]")
  warehouseImages      Json     @default("[]")
  warehouseThumbnails Json     @default("[]")
  status              String   @default("PENDING")
  arrivedBoxesJson     Json     @default("[]")
  totalCalculatedFee  Float?
  warehouseRemark      String?
  claimProof          String?
  exceptionStatus      String?
  exceptionNote        String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  userId              String
  user                User     @relation(fields: [userId], references: [id])
  shipmentId          String?
  shipment            Shipment? @relation(fields: [shipmentId], references: [id])

  @@index([userId])
  @@index([shipmentId])
  @@index([trackingNumber])
}

// --- 3. 集運單資料模型 ---
model Shipment {
  id                    String    @id @default(cuid())
  recipientName         String
  phone                 String
  shippingAddress       String
  idNumber              String
  taxId                 String?
  invoiceTitle          String?
  note                  String?
  // 管理員審核備註：專用於記錄改價、審核意見，與客戶備註分開
  adminNote             String?   @db.Text
  
  // 儲存當時勾選的附加服務快照，例如：[{"name":"釘木架", "price":50}]
  additionalServices    Json?      @default("{}")
  deliveryLocationRate  Float?
  
  // 預設狀態調整為 AWAITING_REVIEW，強制執行後台審核流程
  status                String    @default("AWAITING_REVIEW")
  
  totalCost             Float?
  trackingNumberTW      String?
  paymentProof          String?
  
  carrierType           String?   
  carrierId             String?   
  loadingDate           DateTime? 
  returnReason          String?   

  // 發票相關
  invoiceNumber         String?
  invoiceDate           DateTime?
  invoiceRandomCode     String?
  invoiceStatus         String?
  productUrl            String?
  shipmentProductImages Json      @default("[]")

  transactionId         String?   @unique
  transaction           Transaction? @relation(fields: [transactionId], references: [id])

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  userId                String
  user                  User      @relation(fields: [userId], references: [id])
  packages              Package[]

  @@index([userId])
  @@index([status])
}

// --- 4. 估價單 ---
model CalculationQuote {
  id                String   @id @default(cuid())
  createdAt          DateTime @default(now())
  calculationResult Json
}

// --- 5. 操作日誌 ---
model ActivityLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  action    String
  targetId  String?
  details   String?
  userId    String
  userEmail String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
}

// --- 6. 系統設定 ---
model SystemSetting {
  key         String   @id
  value       Json
  category    String?  // 費率、公告、系統等大類
  group       String?  
  type        String?  
  description String?
  updatedAt   DateTime @updatedAt

  @@index([category])
}

// --- 7. 常用收件人 ---
model Recipient {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  phone       String
  address     String
  idNumber    String?
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
}

// --- 8. 通知中心 ---
model Notification {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title       String
  message     String
  type        String
  isRead      Boolean  @default(false)
  link        String?
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([isRead])
}

// --- 9. 電子錢包 ---
model Wallet {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  balance     Float    @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  transactions Transaction[]
}

// --- 10. 交易紀錄 ---
model Transaction {
  id                String    @id @default(cuid())
  walletId          String
  wallet            Wallet    @relation(fields: [walletId], references: [id], onDelete: Cascade)
  amount            Float
  type              String    // DEPOSIT, PAYMENT, REFUND, ADJUST
  status            String    // PENDING, COMPLETED, FAILED, REJECTED
  description       String?
  proofImage        String?

  taxId             String?  
  invoiceTitle      String?  
  invoiceNumber     String?
  invoiceDate       DateTime?
  invoiceRandomCode String?
  invoiceStatus     String?  

  shipment          Shipment?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([walletId])
  @@index([status])
}

// --- 11. 家具代採購訂單模型 ---
model FurnitureOrder {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // 代採購資訊
  factoryName     String
  productName     String
  
  // 商品參考網址：用於存放商品在淘寶、天貓或工廠官網的連結
  productUrl      String?  @db.Text

  quantity        Int
  priceRMB        Float
  
  // 計算結果與當時費率
  serviceFeeRMB   Float    
  exchangeRate    Float    
  serviceFeeRate Float    
  totalAmountTWD Int      
  
  // 狀態與備註
  status          String   @default("PENDING") 
  note            String?  @db.Text
  adminRemark     String?  @db.Text

  // 參考截圖欄位：用於存放客戶上傳的商品或報價單縮圖路徑
  refImageUrl     String?  @db.Text

  invoiceUrl      String?  @db.Text // 管理員提供的正式發票網址

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

// --- 12. 附加服務定義模型 ---
// 用於管理後台 CRUD 附加服務項目（如：釘木架、加強包裝等）
model ShipmentServiceItem {
  id          String   @id @default(cuid())
  name        String   // 服務名稱
  description String?  // 服務描述內容
  price       Float    @default(0) // 預設單價
  unit        String   @default("PIECE") // 計費單位：PIECE (件), WEIGHT (重量), SHIPMENT (每單)
  isActive    Boolean  @default(true) // 是否在前端顯示供客戶勾選
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}