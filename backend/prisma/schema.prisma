// backend/prisma/schema.prisma
// V18.0 - 終極旗艦優化版：修正 Render 引擎報錯、新增儲位管理、積分獎勵與公告系統

generator client {
  provider      = "prisma-client-js"
  // 強制鎖定 library 引擎，這是解決 Prisma 7 在 Render 部署報錯 P1012 的核心配置
  engineType    = "library"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  // 修正：必須在此處明確指向環境變數，以確保 Prisma Client 能正確識別數據庫引擎類型，防止出現 "adapter" 驗證錯誤
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// --- 1. 會員 (客戶) 資料模型 ---
model User {
  id                  String   @id @default(cuid())
  
  // 專屬會員標識碼：格式為 RP0000889
  piggyId             String?  @unique
  
  email               String   @unique
  
  // passwordHash 改為可選，支持 LINE 快速註冊
  passwordHash        String?
  name                String? 
  phone               String? 
  defaultAddress      String? 

  // 國際化偏好設定
  preferredLanguage   String   @default("zh-TW")
  timezone            String   @default("Asia/Taipei")
  userSettings        Json     @default("{}")

  // [整合] LINE 相關欄位：用於辨識 LINE 客戶與執行後續訊息推播
  lineUserId          String?  @unique

  // 發票預設資料
  defaultTaxId         String?
  defaultInvoiceTitle String?

  // 權限控制
  permissions          Json     @default("[]")

  // 帳號狀態
  isActive            Boolean  @default(true)

  // 忘記密碼欄位
  resetPasswordToken  String?
  resetPasswordExpire DateTime?

  // [新增功能] 會員積分系統
  rewardPoints        Int      @default(0)

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // 關聯
  packages            Package[]
  shipments            Shipment[]
  activityLogs        ActivityLog[]
  recipients          Recipient[]
  wallet              Wallet?
  notifications        Notification[]
  furnitureOrders      FurnitureOrder[]
  
  // 優惠券關聯
  coupons             UserCoupon[]
  
  // [新增] 積分紀錄
  pointRecords        PointRecord[]
}

// --- 2. 包裹 (預報) 資料模型 ---
model Package {
  id                  String   @id @default(cuid())
  trackingNumber      String   @unique
  productName          String
  quantity            Int      @default(1)
  note                String? 
  productUrl          String?  @db.Text

  // 物流規格數據：用於精準材積計算
  weight              Float?   // 重量 (kg)
  length              Float?   // 長 (cm)
  width               Float?   // 寬 (cm)
  height              Float?   // 高 (cm)
  volumeWeight        Float?   // 材積重量 (kg)

  productImages        Json     @default("[]")
  warehouseImages      Json     @default("[]")
  warehouseThumbnails Json     @default("[]")
  status              String   @default("PENDING") // PENDING, ARRIVED, SHELVED, SHIPPED, EXCEPTION
  arrivedBoxesJson     Json     @default("[]")
  totalCalculatedFee  Float?  
  warehouseRemark      String?
  claimProof          String? 
  exceptionStatus      String?
  exceptionNote        String? 
  
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // 關聯
  userId              String
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  shipmentId          String? 
  shipment            Shipment? @relation(fields: [shipmentId], references: [id])
  
  // 歸屬倉庫
  warehouseId         String?
  warehouse           Warehouse? @relation(fields: [warehouseId], references: [id])

  // [新增功能] 儲位管理
  storageBinId        String?
  storageBin          StorageBin? @relation(fields: [storageBinId], references: [id])

  @@index([userId])
  @@index([shipmentId])
  @@index([trackingNumber])
}

// --- 3. 集運單資料模型 ---
model Shipment {
  id                    String    @id @default(cuid())
  recipientName         String
  phone                 String
  shippingAddress       String
  idNumber              String
  taxId                 String?  
  invoiceTitle          String?  
  note                  String?  
  
  // 管理員審核備註
  adminNote             String?    @db.Text
  
  // 儲存當時勾選的附加服務快照
  additionalServices    Json?      @default("{}")
  deliveryLocationRate  Float?   
  
  // 預設狀態
  status                String    @default("AWAITING_REVIEW")
  
  // 費用與實重數據
  totalCost             Float?   
  actualWeight          Float?    // 實際總重量
  chargeableWeight      Float?    // 計費總重量
  
  trackingNumberTW      String?  
  paymentProof          String?  
  carrierType           String?  
  carrierId             String?  
  loadingDate           DateTime?
  returnReason          String?  
  
  // 發票相關
  invoiceNumber         String?  
  invoiceDate           DateTime?
  invoiceRandomCode     String?  
  invoiceStatus         String?  
  productUrl            String?  
  shipmentProductImages Json      @default("[]")

  // 財務與追蹤關聯
  transactionId         String?    @unique
  transaction           Transaction? @relation(fields: [transactionId], references: [id])
  
  // 貨態追蹤歷程關聯
  trackingHistory       TrackingHistory[]

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  packages              Package[]
  
  // 優惠券應用
  couponId              String?  
  coupon                Coupon?   @relation(fields: [couponId], references: [id])

  @@index([userId])
  @@index([status])
}

// --- 4. 貨態追蹤歷程 ---
model TrackingHistory {
  id          String   @id @default(cuid())
  shipmentId  String
  shipment    Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  status      String   // 例如: 倉庫裝櫃、離開港口、清關中、派送中
  description String?  @db.Text
  location    String?
  timestamp   DateTime @default(now())

  @@index([shipmentId])
}

// --- 5. 倉庫管理模型 ---
model Warehouse {
  id          String   @id @default(cuid())
  name        String   // 例如: 東莞集運倉、廣州分發倉
  address     String   @db.Text
  contact     String? 
  isActive    Boolean  @default(true)
  packages    Package[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // [新增] 儲位關聯
  bins        StorageBin[]
}

// --- 6. [新增] 倉庫儲位模型 ---
model StorageBin {
  id          String   @id @default(cuid())
  code        String   // 儲位編號，如 A-01-05
  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  packages    Package[]
  createdAt   DateTime @default(now())

  @@unique([warehouseId, code])
}

// --- 7. 優惠券與行銷系統 ---
model Coupon {
  id            String   @id @default(cuid())
  code          String   @unique
  discountType  String   // PERCENTAGE (百分比), FIXED (固定金額)
  value         Float    // 折扣數值
  minSpend      Float    @default(0) // 最低消費金額
  startDate     DateTime
  endDate       DateTime
  isActive      Boolean  @default(true)
  shipments     Shipment[]
  users         UserCoupon[]
  createdAt     DateTime @default(now())
}

model UserCoupon {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  couponId  String  
  coupon    Coupon   @relation(fields: [couponId], references: [id], onDelete: Cascade)
  isUsed    Boolean  @default(false)
  usedAt    DateTime?
  createdAt DateTime @default(now())

  @@unique([userId, couponId])
}

// --- 8. [新增] 積分紀錄模型 ---
model PointRecord {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount    Int      // 增加或減少的點數
  type      String   // EARNED, USED, EXPIRED, REFUNDED
  reason    String?
  createdAt DateTime @default(now())

  @@index([userId])
}

// --- 9. 估價單 ---
model CalculationQuote {
  id                String   @id @default(cuid())
  createdAt          DateTime @default(now())
  calculationResult Json
}

// --- 10. 操作日誌 ---
model ActivityLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  action    String
  targetId  String? 
  details   String?  @db.Text
  userId    String
  userEmail String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
}

// --- 11. 系統設定 ---
model SystemSetting {
  key         String   @id
  value       Json
  category    String?  // 費率、公告、系統等大類
  group       String?  
  type        String? 
  description String?  @db.Text
  updatedAt   DateTime @updatedAt

  @@index([category])
}

// --- 12. [新增] 系統公告系統 ---
model Announcement {
  id          String   @id @default(cuid())
  title       String
  content     String   @db.Text
  priority    Int      @default(0) // 優先級
  isActive    Boolean  @default(true)
  startDate   DateTime?
  endDate     DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// --- 13. 常用收件人 ---
model Recipient {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  phone       String
  address     String
  idNumber    String? 
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
}

// --- 14. 通知中心 ---
model Notification {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title       String
  message     String   @db.Text
  type        String  
  isRead      Boolean  @default(false)
  link        String? 
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([isRead])
}

// --- 15. 電子錢包 ---
model Wallet {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  balance     Float    @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  transactions Transaction[]
}

// --- 16. 交易紀錄 ---
model Transaction {
  id                String    @id @default(cuid())
  walletId          String
  wallet            Wallet    @relation(fields: [walletId], references: [id], onDelete: Cascade)
  amount            Float
  type              String    // DEPOSIT, PAYMENT, REFUND, ADJUST
  status            String    // PENDING, COMPLETED, FAILED, REJECTED
  description       String?   @db.Text
  proofImage        String?  
  taxId             String?  
  invoiceTitle      String?
  invoiceNumber     String?  
  invoiceDate       DateTime?
  invoiceRandomCode String?
  invoiceStatus     String?  
  shipment          Shipment?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([walletId])
  @@index([status])
}

// --- 17. 家具代採購訂單模型 ---
model FurnitureOrder {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  factoryName     String
  productName     String  
  productUrl      String?  @db.Text

  quantity        Int
  priceRMB        Float
  
  serviceFeeRMB   Float    
  exchangeRate    Float    
  serviceFeeRate  Float    
  totalAmountTWD  Int      
  
  status          String   @default("PENDING") 
  note            String?  @db.Text
  adminRemark     String?  @db.Text

  refImageUrl     String?  @db.Text
  invoiceUrl      String?  @db.Text

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

// --- 18. 附加服務定義模型 ---
model ShipmentServiceItem {
  id          String   @id @default(cuid())
  name        String   
  description String?  @db.Text
  price       Float    @default(0)
  unit        String   @default("PIECE") 
  isActive    Boolean  @default(true) 
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}